name: Build FlareSolverr (Debian 11 - Git Clone)

on:
  workflow_dispatch: # Chạy thủ công

permissions:
  contents: write # Cấp quyền để upload file Release

jobs:
  build-manual-clone:
    name: Build on Debian 11
    runs-on: ubuntu-latest
    container:
      image: python:3.13-bullseye # Debian 11 (Fix GLIBC) + Python 3.13
      options: --user root

    steps:
      - name: Install System Tools
        # Cập nhật và cài git để chạy lệnh clone
        run: |
          apt-get update
          apt-get install -y git zip

      - name: Manual Clone Repository
        # Thay thế actions/checkout bằng lệnh clone đơn giản
        run: |
          echo "Cloning FlareSolverr..."
          git clone --depth 1 https://github.com/FlareSolverr/FlareSolverr.git src_code

      - name: Install & Build
        run: |
          cd src_code
          
          echo "Installing Python Dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
          echo "Building Binary..."
          cd src
          python build_package.py

      - name: Compress & Prepare
        id: prepare_files
        run: |
          cd src_code/dist
          
          # Đổi tên file để phân biệt
          mv flaresolverr_linux_x64 flaresolverr_linux_x64_debian11
          
          # Nén file tar.gz
          tar -czvf flaresolverr_debian11.tar.gz flaresolverr_linux_x64_debian11
          
          # Lưu đường dẫn và tạo tag
          echo "file_path=$(pwd)/flaresolverr_debian11.tar.gz" >> $GITHUB_OUTPUT
          echo "date_tag=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.prepare_files.outputs.date_tag }}
          name: FlareSolverr (Debian 11 Fix - Py3.13)
          body: |
            Bản build thủ công từ source mới nhất.
            - **Cách build**: Git Clone trực tiếp + Docker Debian 11.
            - **Hệ điều hành**: Debian 11 (GLIBC cũ -> Chạy được trên mọi VPS).
            - **Python**: 3.13.
          files: ${{ steps.prepare_files.outputs.file_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
