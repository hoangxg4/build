name: Build FlareSolverr (Debian 11 + Py3.13)

on:
  workflow_dispatch: # Chạy thủ công

permissions:
  contents: write # Quyền tạo Release

jobs:
  build-debian-11:
    name: Build on Debian 11 (Bullseye)
    runs-on: ubuntu-latest
    # Sử dụng Container Debian 11 có sẵn Python 3.13 chính chủ
    container:
      image: python:3.13-bullseye
      options: --user root

    steps:
      - name: Install Git & Tools
        # Cập nhật và cài git để checkout code
        run: |
          apt-get update
          apt-get install -y git zip

      - name: Checkout Latest FlareSolverr
        uses: actions/checkout@v4
        with:
          repository: FlareSolverr/FlareSolverr # Lấy code gốc
          ref: main                             # Nhánh mới nhất
          path: src_code

      - name: Build Binary
        run: |
          cd src_code
          
          echo "Installing Dependencies..."
          # Đã có sẵn Python 3.13, chạy pip luôn
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
          echo "Building Package..."
          cd src
          python build_package.py

      - name: Prepare Output
        id: package
        run: |
          cd src_code/dist
          
          # Đổi tên file để dễ nhận biết
          mv flaresolverr_linux_x64 flaresolverr_linux_x64_debian11
          
          # Nén file tar.gz
          tar -czvf flaresolverr_debian11.tar.gz flaresolverr_linux_x64_debian11
          
          # Xuất đường dẫn file ra biến môi trường
          echo "file_path=$(pwd)/flaresolverr_debian11.tar.gz" >> $GITHUB_OUTPUT
          echo "date_tag=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: debian11-build-${{ steps.package.outputs.date_tag }}
          name: FlareSolverr (Debian 11 Base - Py3.13)
          body: |
            Bản build mới nhất từ nhánh `main`.
            - **Base OS**: Debian 11 (Bullseye) -> Fix lỗi GLIBC version.
            - **Python**: 3.13
            - **Tương thích**: Chạy tốt trên Debian 11, Ubuntu 20.04 và các hệ thống dùng GLIBC 2.31+.
          files: ${{ steps.package.outputs.file_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
