name: Build FlareSolverr (Debian 11)

on:
  workflow_dispatch: # Chạy thủ công

permissions:
  contents: write # Cấp quyền tạo Release

jobs:
  build-final:
    name: Build on Debian 11
    runs-on: ubuntu-latest
    container:
      image: python:3.13-bullseye # Môi trường Debian 11 + Python 3.13 (Fix GLIBC)
      options: --user root

    steps:
      - name: Install System Tools
        run: |
          apt-get update
          apt-get install -y git zip tar build-essential

      - name: Manual Clone Repository
        run: |
          echo "Cloning FlareSolverr..."
          # Clone code về thư mục src_code
          git clone --depth 1 https://github.com/FlareSolverr/FlareSolverr.git src_code

      - name: Install Dependencies & Build
        run: |
          cd src_code
          
          echo "Installing Python Libraries..."
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          
          echo "Running build script..."
          cd src
          # Script này sẽ tự làm tất cả: Tải Chrome -> Build -> Nén thành .tar.gz
          python build_package.py

      - name: Prepare Artifact
        id: prepare_files
        run: |
          cd src_code/dist
          
          echo "Kiểm tra file được tạo ra:"
          ls -lah
          
          # File do Python tạo ra tên là: flaresolverr_linux_x64.tar.gz
          # Chúng ta đổi tên nó thành tên bạn muốn
          mv flaresolverr_linux_x64.tar.gz flaresolverr_debian11.tar.gz
          
          # Xuất đường dẫn file
          echo "file_path=$(pwd)/flaresolverr_debian11.tar.gz" >> $GITHUB_OUTPUT
          
          # Tạo tag theo thời gian
          echo "date_tag=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.prepare_files.outputs.date_tag }}
          name: FlareSolverr (Debian 11 - Py3.13)
          body: |
            Bản build tự động từ source gốc.
            - **Cơ chế**: Dùng script `build_package.py` gốc.
            - **Hệ điều hành**: Debian 11 (Bullseye) -> Fix lỗi GLIBC 2.38.
            - **Python**: 3.13.
          files: ${{ steps.prepare_files.outputs.file_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
